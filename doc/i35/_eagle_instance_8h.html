<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>eagle: eagle/eagle/EagleInstance.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_9fb070f42e74af95faa7b0497164f110.html">eagle</a>&nbsp;&raquo;&nbsp;<a class="el" href="dir_d5e7e0a56b24dd6f912b01ced07788a2.html">eagle</a>
  </div>
</div>
<div class="contents">
<h1>EagleInstance.h File Reference</h1><code>#include &lt;pthread.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="_eagle_workers_8h_source.html">EagleWorkers.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="_eagle_page_provider_8h_source.html">EaglePageProvider.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="_eagle_plan_job_8h_source.html">EaglePlanJob.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="_eagle_synchronizer_8h_source.html">EagleSynchronizer.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="_eagle_8h_source.html">Eagle.h</a>&quot;</code><br/>

<p><a href="_eagle_instance_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_eagle_instance__.html">EagleInstance</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">An eagle instance (a database).  <a href="struct_eagle_instance__.html#_details">More...</a><br/></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_eagle_instance_8h.html#a04799f2a6588421bb8235faa8144f78f">EagleInstance_addPlan</a> (EagleInstance *eagle, <a class="el" href="struct_eagle_plan.html">EaglePlan</a> *plan)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add an <a class="el" href="struct_eagle_plan.html">EaglePlan</a> to an EagleInstance.  <a href="#a04799f2a6588421bb8235faa8144f78f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_eagle_instance_8h.html#a21f9875e7adcb02f2370897749e56181">EagleInstance_Delete</a> (EagleInstance *eagle)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free EagleInstance.  <a href="#a21f9875e7adcb02f2370897749e56181"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">EagleInstance *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_eagle_instance_8h.html#af3888839e04de3cc548480228920c3a7">EagleInstance_New</a> (int totalWorkers)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create a new eagle instance.  <a href="#af3888839e04de3cc548480228920c3a7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="struct_eagle_plan_job.html">EaglePlanJob</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_eagle_instance_8h.html#a5c98e51b3ffa85b9f5892522979b41a2">EagleInstance_nextJob</a> (EagleInstance *eagle)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the next finite job from the stack.  <a href="#a5c98e51b3ffa85b9f5892522979b41a2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_eagle_instance_8h.html#a683dd58ebffac2f2f0fa090bf46a032d">EagleInstance_run</a> (EagleInstance *eagle)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Run the instance.  <a href="#a683dd58ebffac2f2f0fa090bf46a032d"></a><br/></td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a04799f2a6588421bb8235faa8144f78f"></a><!-- doxytag: member="EagleInstance.h::EagleInstance_addPlan" ref="a04799f2a6588421bb8235faa8144f78f" args="(EagleInstance *eagle, EaglePlan *plan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void EagleInstance_addPlan </td>
          <td>(</td>
          <td class="paramtype">EagleInstance *&nbsp;</td>
          <td class="paramname"> <em>eagle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_eagle_plan.html">EaglePlan</a> *&nbsp;</td>
          <td class="paramname"> <em>plan</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add an <a class="el" href="struct_eagle_plan.html">EaglePlan</a> to an EagleInstance. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>eagle</em>&nbsp;</td><td>Instance. </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>plan</em>&nbsp;</td><td>The plan to execute. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_eagle_instance_8c_source.html#l00032">32</a> of file <a class="el" href="_eagle_instance_8c_source.html">EagleInstance.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00033"></a>00033 {
<a name="l00034"></a>00034     eagle-&gt;plan = plan;
<a name="l00035"></a>00035 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a21f9875e7adcb02f2370897749e56181"></a><!-- doxytag: member="EagleInstance.h::EagleInstance_Delete" ref="a21f9875e7adcb02f2370897749e56181" args="(EagleInstance *eagle)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void EagleInstance_Delete </td>
          <td>(</td>
          <td class="paramtype">EagleInstance *&nbsp;</td>
          <td class="paramname"> <em>eagle</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Free EagleInstance. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>eagle</em>&nbsp;</td><td>Instance. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_eagle_instance_8c_source.html#l00080">80</a> of file <a class="el" href="_eagle_instance_8c_source.html">EagleInstance.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00081"></a>00081 {
<a name="l00082"></a>00082     <span class="keywordflow">if</span>(NULL == eagle) {
<a name="l00083"></a>00083         <span class="keywordflow">return</span>;
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085     
<a name="l00086"></a>00086     <a class="code" href="_eagle_workers_8c.html#af409e7dcd3ed135dc4daae5f40ab4a4d">EagleWorkers_Delete</a>(eagle-&gt;workers);
<a name="l00087"></a>00087     <a class="code" href="_eagle_lock_8c.html#a87e2254b1b165636debfd228f13bd4d6">EagleLock_Delete</a>(eagle-&gt;nextJobLock);
<a name="l00088"></a>00088     <a class="code" href="_eagle_memory_8c.html#aaa3b2daf6c57f2aa57de0ade732caeb5" title="Free a pointer.">EagleMemory_Free</a>(eagle);
<a name="l00089"></a>00089 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af3888839e04de3cc548480228920c3a7"></a><!-- doxytag: member="EagleInstance.h::EagleInstance_New" ref="af3888839e04de3cc548480228920c3a7" args="(int totalWorkers)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">EagleInstance* EagleInstance_New </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>totalWorkers</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create a new eagle instance. </p>
<p>The instance is effectivly a database, with a certain amount of workers (threads) that will carry out the work. Do not create multiple instances for the same database as there is no way to syncronise them.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>totalWorkers</em>&nbsp;</td><td>The number of workers to launch, this does not include the main thread that will handle the connections and look after the workers. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_eagle_instance_8c_source.html#l00009">9</a> of file <a class="el" href="_eagle_instance_8c_source.html">EagleInstance.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00010"></a>00010 {
<a name="l00011"></a>00011     EagleInstance *instance = (EagleInstance*) <a class="code" href="_eagle_memory_8c.html#a21ad14d6772cd800661d5f2a29d18d2b" title="Allocate a single block of memory.">EagleMemory_Allocate</a>(<span class="stringliteral">&quot;EagleInstance_New.1&quot;</span>, <span class="keyword">sizeof</span>(EagleInstance));
<a name="l00012"></a>00012     <span class="keywordflow">if</span>(NULL == instance) {
<a name="l00013"></a>00013         <span class="keywordflow">return</span> NULL;
<a name="l00014"></a>00014     }
<a name="l00015"></a>00015     
<a name="l00016"></a>00016     instance-&gt;workers = <a class="code" href="_eagle_workers_8c.html#a471f464cc0078e16bd057dd72c7a5132">EagleWorkers_New</a>(totalWorkers, instance);
<a name="l00017"></a>00017     instance-&gt;nextJobLock = <a class="code" href="_eagle_synchronizer_8c.html#a98913d5b1b10058b0e839dabdbcaed12" title="Create a new EagleLock.">EagleSynchronizer_CreateLock</a>();
<a name="l00018"></a>00018     instance-&gt;plan = NULL;
<a name="l00019"></a>00019     
<a name="l00020"></a>00020     <span class="keywordflow">return</span> instance;
<a name="l00021"></a>00021 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5c98e51b3ffa85b9f5892522979b41a2"></a><!-- doxytag: member="EagleInstance.h::EagleInstance_nextJob" ref="a5c98e51b3ffa85b9f5892522979b41a2" args="(EagleInstance *eagle)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="struct_eagle_plan_job.html">EaglePlanJob</a>* EagleInstance_nextJob </td>
          <td>(</td>
          <td class="paramtype">EagleInstance *&nbsp;</td>
          <td class="paramname"> <em>eagle</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the next finite job from the stack. </p>
<p>This is a syncronised method that all the workers will call independantly when they have nothing to do. If this method returns NULL it is upto the workers to know that there is no more work, they will check periodically after that.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>eagle</em>&nbsp;</td><td>Instance. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Initialised <a class="el" href="struct_eagle_plan_job.html">EaglePlanJob</a>, or NULL if there are no available jobs. </dd></dl>

<p>Definition at line <a class="el" href="_eagle_instance_8c_source.html#l00037">37</a> of file <a class="el" href="_eagle_instance_8c_source.html">EagleInstance.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00038"></a>00038 {
<a name="l00039"></a>00039     <a class="code" href="struct_eagle_plan.html">EaglePlan</a> *plan = NULL;
<a name="l00040"></a>00040     <a class="code" href="struct_eagle_plan_job.html">EaglePlanJob</a> *job = NULL;
<a name="l00041"></a>00041     <span class="keywordtype">int</span> i;
<a name="l00042"></a>00042     uint64_t now, then;
<a name="l00043"></a>00043     
<a name="l00044"></a>00044     <span class="comment">/* synchronize this function */</span>
<a name="l00045"></a>00045     now = mach_absolute_time();
<a name="l00046"></a>00046     <a class="code" href="_eagle_synchronizer_8c.html#ad0b9c556aa67109497e7a324f5a905f5" title="Lock an EagleLock.">EagleSynchronizer_Lock</a>(eagle-&gt;nextJobLock);
<a name="l00047"></a>00047     then = mach_absolute_time();
<a name="l00048"></a>00048     
<a name="l00049"></a>00049     plan = eagle-&gt;plan;
<a name="l00050"></a>00050     plan-&gt;<a class="code" href="struct_eagle_plan.html#aa1f5552fecc9ddaca9838e044ad2e6b3" title="This is the total amount of time the plan has spent waiting for locks.">lockWaitTime</a> += then - now;
<a name="l00051"></a>00051     <a class="code" href="_eagle_plan_8c.html#af183653e62639aca5e4a3205940a7842">EaglePlan_resumeTimer</a>(plan);
<a name="l00052"></a>00052     job = <a class="code" href="_eagle_plan_job_8c.html#a917a60c7b643ae5891f97f10cdb22705">EaglePlanJob_New</a>(plan);
<a name="l00053"></a>00053     
<a name="l00054"></a>00054     <span class="keywordflow">for</span>(i = 0; i &lt; plan-&gt;<a class="code" href="struct_eagle_plan.html#a1b8a85e4ccd7e5ddcd33d360031c7f1d" title="The number of used providers.">usedProviders</a>; ++i) {
<a name="l00055"></a>00055         <a class="code" href="struct_eagle_plan_buffer_provider.html" title="This structure acts as a link between a page providers data and the buffer for an...">EaglePlanBufferProvider</a> *provider = plan-&gt;<a class="code" href="struct_eagle_plan.html#aee10ff6da9ca46f12e027039d1f5de7a" title="The page providers.">providers</a>[i];
<a name="l00056"></a>00056         <span class="keywordflow">if</span>(<a class="code" href="_eagle_page_provider_8c.html#a2c871cdcad6ce101ef48504808713bc2">EaglePageProvider_pagesRemaining</a>(provider-&gt;<a class="code" href="struct_eagle_plan_buffer_provider.html#ac91a7ca6db9fa7657a09456f764e5a89" title="The provider that contains the actual data for the buffer.">provider</a>) == 0) {
<a name="l00057"></a>00057             <a class="code" href="_eagle_plan_job_8c.html#acb8ec253ecb74dc0603daf5902175473">EaglePlanJob_Delete</a>(job);
<a name="l00058"></a>00058             job = NULL;
<a name="l00059"></a>00059             <span class="keywordflow">break</span>;
<a name="l00060"></a>00060         }
<a name="l00061"></a>00061         
<a name="l00062"></a>00062         <span class="keywordflow">if</span>(provider-&gt;<a class="code" href="struct_eagle_plan_buffer_provider.html#a8523b510ebeb9f430d2f9c8346046c6a" title="The buffer ID where the next page will be loaded into.">destinationBuffer</a> &gt;= plan-&gt;<a class="code" href="struct_eagle_plan.html#a9021062c2280f08138aabe013bfa3746" title="The number of buffers needed for the execution.">buffersNeeded</a>) {
<a name="l00063"></a>00063             <span class="keywordtype">char</span> msg[1024];
<a name="l00064"></a>00064             sprintf(msg, <span class="stringliteral">&quot;destination %d is greater than allowed %d buffers!\n&quot;</span>, provider-&gt;<a class="code" href="struct_eagle_plan_buffer_provider.html#a8523b510ebeb9f430d2f9c8346046c6a" title="The buffer ID where the next page will be loaded into.">destinationBuffer</a>, plan-&gt;<a class="code" href="struct_eagle_plan.html#a9021062c2280f08138aabe013bfa3746" title="The number of buffers needed for the execution.">buffersNeeded</a>);
<a name="l00065"></a>00065             <a class="code" href="_eagle_logger_8c.html#a2b11ce5acff2e74749d6ad9e181e67e8" title="Log an event.">EagleLogger_Log</a>(<a class="code" href="_eagle_logger_severity_8h.html#a7316d55576378a753facf17fa36597e2a76a93f9f51daaaaf8a119a878fa74988" title="An error is a problem that has stopped a task from continuing but the state of the...">EagleLoggerSeverityError</a>, msg);
<a name="l00066"></a>00066             
<a name="l00067"></a>00067             <a class="code" href="_eagle_plan_job_8c.html#acb8ec253ecb74dc0603daf5902175473">EaglePlanJob_Delete</a>(job);
<a name="l00068"></a>00068             job = NULL;
<a name="l00069"></a>00069             <span class="keywordflow">break</span>;
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071         <a class="code" href="_eagle_page_8c.html#a1335c4aeab6d307f25a8e06f90240d12">EaglePage_Delete</a>(job-&gt;<a class="code" href="struct_eagle_plan_job.html#a7a59ef221cdbb2e4dca970dd00103bbc" title="The buffers.">buffers</a>[provider-&gt;<a class="code" href="struct_eagle_plan_buffer_provider.html#a8523b510ebeb9f430d2f9c8346046c6a" title="The buffer ID where the next page will be loaded into.">destinationBuffer</a>]);
<a name="l00072"></a>00072         job-&gt;<a class="code" href="struct_eagle_plan_job.html#a7a59ef221cdbb2e4dca970dd00103bbc" title="The buffers.">buffers</a>[provider-&gt;<a class="code" href="struct_eagle_plan_buffer_provider.html#a8523b510ebeb9f430d2f9c8346046c6a" title="The buffer ID where the next page will be loaded into.">destinationBuffer</a>] = <a class="code" href="_eagle_page_provider_8c.html#a0ceaedea95767ce9e5d3134ca0ac90a8">EaglePageProvider_nextPage</a>(provider-&gt;<a class="code" href="struct_eagle_plan_buffer_provider.html#ac91a7ca6db9fa7657a09456f764e5a89" title="The provider that contains the actual data for the buffer.">provider</a>);
<a name="l00073"></a>00073     }
<a name="l00074"></a>00074     
<a name="l00075"></a>00075     <a class="code" href="_eagle_synchronizer_8c.html#a6a41ea4ba599f003f8671993660464d6" title="Unlock an EagleLock.">EagleSynchronizer_Unlock</a>(eagle-&gt;nextJobLock);
<a name="l00076"></a>00076     <a class="code" href="_eagle_plan_8c.html#a7e57687dea3e68704a5b223f670b00f2">EaglePlan_stopTimer</a>(plan);
<a name="l00077"></a>00077     <span class="keywordflow">return</span> job;
<a name="l00078"></a>00078 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a683dd58ebffac2f2f0fa090bf46a032d"></a><!-- doxytag: member="EagleInstance.h::EagleInstance_run" ref="a683dd58ebffac2f2f0fa090bf46a032d" args="(EagleInstance *eagle)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void EagleInstance_run </td>
          <td>(</td>
          <td class="paramtype">EagleInstance *&nbsp;</td>
          <td class="paramname"> <em>eagle</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Run the instance. </p>
<p>This will start it.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>eagle</em>&nbsp;</td><td>Instance from <a class="el" href="_eagle_instance_8c.html#af3888839e04de3cc548480228920c3a7" title="Create a new eagle instance.">EagleInstance_New()</a> </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_eagle_instance_8c_source.html#l00023">23</a> of file <a class="el" href="_eagle_instance_8c_source.html">EagleInstance.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00024"></a>00024 {
<a name="l00025"></a>00025     <span class="comment">/* start workers */</span>
<a name="l00026"></a>00026     <a class="code" href="_eagle_workers_8c.html#a61f9797eee35f27a4a9e308d6d235e94">EagleWorkers_start</a>(eagle-&gt;workers);
<a name="l00027"></a>00027     
<a name="l00028"></a>00028     <span class="comment">/* close workers */</span>
<a name="l00029"></a>00029     <a class="code" href="_eagle_workers_8c.html#a47cf93cd3e01b6f6c179f39381fc90b8">EagleWorkers_joinAll</a>(eagle-&gt;workers);
<a name="l00030"></a>00030 }
</pre></div></p>

</div>
</div>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Sun Jan 27 16:19:47 2013 for eagle by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
